name: Build APK
on: push

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # s√©curit√© si Gradle freeze

    steps:
      # 1Ô∏è‚É£ Checkout le repo
      - name: Checkout
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Installer Node.js
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          # on supprime totalement "cache" pour √©viter l'erreur

      # 3Ô∏è‚É£ Installer les d√©pendances npm
      - name: Install dependencies
        run: npm install --legacy-peer-deps

      # 4Ô∏è‚É£ S'assurer qu'async-storage est pr√©sent
      - name: Ensure async-storage installed
        run: |
          if ! npm list @react-native-async-storage/async-storage >/dev/null 2>&1; then
            npm install @react-native-async-storage/async-storage --legacy-peer-deps
          fi

      # 5Ô∏è‚É£ Installer Android SDK correctement via action
      - name: Setup Android SDK
        uses: malinskiy/setup-android@v2
        with:
          api-level: 33
          build-tools: 33.0.2

      # 6Ô∏è‚É£ Expo prebuild
      - name: Expo prebuild
        run: npx expo prebuild --platform android --no-install

      # 7Ô∏è‚É£ Rendre gradlew ex√©cutable
      - name: Make gradlew executable
        run: chmod +x android/gradlew

      # 8Ô∏è‚É£ Build Gradle avec retry si Kotlin incompatible
      - name: Build Android Release
        working-directory: android
        run: |
          KOTLIN_VERSIONS=("2.2.20" "2.2.10" "2.2.0" "2.1.21" "2.1.20" "2.0.21")
          for KV in "${KOTLIN_VERSIONS[@]}"; do
              echo "Trying Kotlin version $KV"
              ./gradlew assembleRelease -PkotlinVersion=$KV && break
          done

      # 9Ô∏è‚É£ Upload APK
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: android/app/build/outputs/apk/release/app-release.apk

      # üîü Upload package-lock.json pour debug
      - name: Upload package-lock
        uses: actions/upload-artifact@v4
        with:
          name: package-lock
          path: package-lock.json
